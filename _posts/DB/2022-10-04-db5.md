---
layout: single
title: "DBMS: SQL"
categories: DB
tag: [Database, SQL]
toc: true
toc_sticky: true
toc_label: "ì­ŒìŠ¤log"
#author_profile: false
header:
    teaser: /assets/images/posts/db.png
sidebar:
    nav: "docs"
---

# INTRO ğŸ™Œ
ì €ë²ˆ ì‹œê°„ì—ëŠ” ER Diagramì„ Relation Model/Designìœ¼ë¡œ ë³€í™˜ì— ëŒ€í•˜ì—¬ ì•Œì•„ë³´ì•˜ë‹¤.

ì´ë²ˆ ì‹œê°„ì—ëŠ” ì‹¤ì§ˆì ìœ¼ë¡œ **SQL(Structured Query Language)**ì„ ì‚¬ìš©í•˜ì—¬ ëª¨ë¸ì„ ìƒì„±í•´ë³´ì.

        SELECT    S
        FROM       R1,â€¦,Rn
        WHERE    C1
        GROUP BY a1,â€¦,ak
        HAVING     C2

****
# SQL ê¸°ë³¸ âœŒ
- ëŒ€ì†Œë¬¸ì êµ¬ë¶„ X
- ë¬¸ì¥ ë§¨ ë’¤ ;
- ë¬¸ìì—´ì€ ì‘ì€ ë”°ì˜´í‘œ(')ë¡œ í‘œì‹œ
- '==' ëŒ€ì‹  '='
- NULLì€ ì§‘ê³„ í•¨ìˆ˜ì— ì˜í–¥ x

## SQL ì¿¼ë¦¬ êµ¬ì¡°
        SELECT [ALL | DISTINCT] ì†ì„±ì´ë¦„ë“¤
        FROM í…Œì´ë¸”ì´ë¦„ë“¤
        WHERE ì¡°ê±´ë“¤
        GROUP BY ì†ì„±ì´ë¦„
        HAVING ê²€ìƒ‰ì¡°ê±´ë“¤
        ORDER BY ì†ì„±ì´ë¦„ [ASC | DESC]

## SQL ë¬¸ë²• ì²˜ë¦¬ìˆœì„œ
        1. FROM
        2. ON
        3. JOIN
        4. WHERE
        5. GROUP BY
        6. HAVING
        7. SELECT
        8. DISTINCT
        9. ORDER BY
        10. TOP

## ì§‘ê³„ í•¨ìˆ˜
        SUM([ALL | DISTINCT] ì†ì„±ì´ë¦„)
        AVG([ALL | DISTINCT] ì†ì„±ì´ë¦„)
        COUNT({[[ALL | DISTINCT] ì†ì„±ì´ë¦„] | *})
        MAX([ALL | DISTINCT] ì†ì„±ì´ë¦„)
        MIN([ALL | DISTINCT] ì†ì„±ì´ë¦„)

> DISTINCT: ì¤‘ë³µ ì œê±°

****
# SQL ë¬¸ë²•ğŸ’œ
> Single-Relation Query
>> í•˜ë‚˜ì˜ ê´€ê³„(í…Œì´ë¸”)ë¥¼ í¬í•¨í•˜ëŠ” ì¿¼ë¦¬ë¬¸ ì‘ì„±

		SELECT *
		FROM Beers
		WHERE manf = â€˜Anheuser-Buschâ€™;

> Multi-Table Queries
>> ë‹¤ìˆ˜ì˜ ê´€ê³„(í…Œì´ë¸”)ë“¤ì„ í¬í•¨í•˜ëŠ” ì¿¼ë¦¬ë¬¸ ì‘ì„±

        SELECT Person.name
        FROM Person, Purchase, Product
        WHERE Person.name=Purchase.buyer AND Product=Product.name AND Product.category=â€œtelephonyâ€

## Select, From, Where
        SELECT   ì†ì„±ë“¤
        FROM     í…Œì´ë¸”ë“¤
        WHERE    ì¡°ê±´ë“¤

*Beers* í…Œì´ë¸”ì—ì„œ *Anheuser-Busch* íšŒì‚¬ì—ì„œ ë§Œë“  ë§¥ì£¼ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°

		SELECT *
		FROM Beers
		WHERE manf = â€˜Anheuser-Buschâ€™;

> Output:
> ![image](https://user-images.githubusercontent.com/39285147/195394010-4829098e-fb4b-49a7-b964-9d00dca984ce.png)

## AND, OR, NOT, AS, LIKE
### AND Operator
        SELECT *
        FROM Company
        WHERE country="USA" AND stockPrice > 50

### AS Operator
        SELECT bar, beer, price * 120 AS priceInYen
        FROM Sells;

> Output:
> ![image](https://user-images.githubusercontent.com/39285147/195394910-da6218e3-0801-489b-99b4-509ce0d41698.png)

        SELECT drinker, â€˜likes Budâ€™ AS whoLikesBud
        FROM Likes
        WHERE beer = â€˜Budâ€™;

> Output:
> ![image](https://user-images.githubusercontent.com/39285147/195395096-a7533bad-3955-4448-bc8e-faccc1b3f407.png)

### LIKE Operator
        <Attribute> LIKE <pattern>
        <Attribute> NOT LIKE <pattern>

%  = any sequence of characters

_   = any single character

        SELECT name
        FROM Drinkers
        WHERE phone LIKE â€˜%555-_ _ _ _â€™;

        SELECT *
        FROM Company
        WHERE country=â€œUSAâ€ AND address LIKE â€œ%Mountain%â€

## Explicit Tuple-Variables
        SELECT b1.name, b2.name
            FROM Beers b1, Beers b2
            WHERE b1.manf = b2.manf AND
                b1.name < b2.name;

        SELECT b1.name, b2.name
            FROM Beers AS b1, Beers AS b2
            WHERE b1.manf = b2.manf AND
                b1.name < b2.name;

ìƒê¸° ì¿¼ë¦¬ë¬¸ì—ì„œ **Beers b1, Beers b2** ë¶€ë¶„ì— í•´ë‹¹í•œë‹¤.

ì—¬ê¸°ì„œ, Tuple Variableì€ ê°ê° b1, b2ì´ë‹¤.

ë‹¤ìŒ ì˜ˆì‹œ ë˜í•œ ì°¸ê³ í•´ë³´ì.

        SELECT a1, a2, â€¦, ak
        FROM    R1 AS x1, R2 AS x2, â€¦, Rn AS xn
        WHERE  Conditions

[*Nested Loops*]

![image](https://user-images.githubusercontent.com/39285147/195452009-d427e1f2-d459-4421-88ce-b0453b243e4b.png)

[*Parallel Assignment*]

![image](https://user-images.githubusercontent.com/39285147/195452140-88370af2-fb40-43d5-8564-ffe71c2638ed.png)

[*Translation to Relational algebra*]

![image](https://user-images.githubusercontent.com/39285147/195452380-f46dbc60-9ef5-4195-a4e1-4a32890e768a.png)

## Group-by, Having
### Group-by
Sells(bar, beer, price) í…Œì´ë¸”ì—ì„œ **ë§¥ì£¼ë³„** í‰ê·  ê°€ê²© êµ¬í•˜ê¸°:

        SELECT beer, AVG(price)
        FROM Sells
        GROUP BY beer;

â€» ë§Œì•½ ì¿¼ë¦¬ê°€ ì§‘ê³„ í•¨ìˆ˜ í¬í•¨ â†’ SELECTë¡œ ë‚´ë³´ë‚¼ ë‹¤ë¥¸ ìš”ì†Œ ë˜í•œ ì§‘ê³„ëê±°ë‚˜, í•´ë‹¹ ì†ì„±ì´ GROUP BY ëª©ë¡ì— í¬í•¨ë˜ì–´ì•¼ í•œë‹¤.

ìƒê¸° ê²½ìš°ëŠ” beer ë³„ ê·¸ë£¹í™”ë¥¼ ì§„í–‰í•˜ê³ , SELECTì—ì„œ beer, AVG(price)ë¥¼ ë„ì¶œí•œë‹¤.
- beer ë³„ ê·¸ë£¹í™” --> beerì€ ì§‘ê³„í•¨ìˆ˜ ì‚¬ìš© ì•ˆ í•´ë„ ë¬´ë°©

ì•„ë˜ ì˜ˆì‹œë¥¼ í†µí•´ ì´í•´í•´ë³´ì.

        SELECT bar, MIN(price)
        FROM Sells
        WHERE beer = â€˜Budâ€™;

price ì†ì„±ì€ ì§‘ê³„ í•¨ìˆ˜ê°€ ì‚¬ìš©ëœ ë°˜ë©´, bar ì†ì„±ì€ ì§‘ê³„ë˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ ì˜¤ë¥˜ì´ë‹¤.

bar ë˜í•œ ì§‘ê³„ í•¨ìˆ˜ê°€ ì‚¬ìš©ë˜ì–´ì•¼ í•œë‹¤.

### Having
GROUP BY ì‚¬ìš©ìœ¼ë¡œ ìƒì„±ëœ ê° ê·¸ë£¹ë³„ë¡œ HAVING ì¡°ê±´ì— í•´ë‹¹ë˜ì§€ ì•ŠëŠ” Tuple ì œê±°.

[*ì˜ˆì‹œ*]

*Sells(bar, beer, price) & Beers(name, manf)*: Pete'sì— ì˜í•´ ì œì‘ë˜ì—ˆê±°ë‚˜ 3ê°œ ì´ìƒì˜ barsì—ì„œ íŒë§¤ë˜ê³  ìˆëŠ” ë§¥ì£¼ë“¤ì˜ í‰ê·  ê°€ê²© êµ¬í•˜ê¸°

        SELECT beer, AVG(price)
        FROM Sells
        GROUP BY beer
        HAVING COUNT(bar) >= 3 OR beer IN (SELECT name FROM Beers WHERE manf = â€˜Peteâ€™â€™sâ€™);

## NULL Value
**Missing value(ê²°ì¸¡ì¹˜)** í˜¹ì€ **Inapplicable(í•´ë‹¹ì—†ìŒ)**

í•˜ê¸° ì¿¼ë¦¬ë¬¸ì€ ë‚˜ì´ ì •ë³´ë¡œ NULL ê°’ì„ ê°€ì§€ëŠ” ì‚¬ëŒë“¤ì€ í¬í•¨í•˜ì§€ ì•ŠëŠ”ë‹¤.

        SELECT *
        FROM     Person
        WHERE  age < 25  OR  age >= 25

ë”°ë¼ì„œ, í•˜ê¸° ì¿¼ë¦¬ë¬¸ì²˜ëŸ¼ ì§ì ‘ NULL ê²½ìš°ì— ëŒ€í•œ ì¡°ê±´ì„ ì¶”ê°€í•´ì•¼ í•œë‹¤.

        SELECT *
        FROM     Person
        WHERE  age < 25  OR  age >= 25 OR age IS NULL

## Subqueries
*Sells(bar, beer, price)*, Joeê°€ Bud êµ¬ë§¤ì— ì§€ë¶ˆí•œ ê°€ê²©ê³¼ ë™ì¼í•œ ê°€ê²©ìœ¼ë¡œ Millerë¥¼ íŒë§¤í•˜ëŠ” bars êµ¬í•˜ê¸°

        SELECT bar
        FROM Sells
        WHERE beer = â€˜Millerâ€™ AND
            price = (SELECT price
                    FROM Sells
                    WHERE bar = â€˜Joeâ€™â€™s Barâ€™
                    AND beer = â€˜Budâ€™);

## Boolean Operators IN, EXISTS, ANY, ALL
### IN
IN(\<relation\>): í•˜ë‚˜ë¼ë„ í¬í•¨

*Beers(name, manf) and Likes(drinker, beer)*, Fredê°€ ì¢‹ì•„í•˜ëŠ” ë§¥ì£¼ ì œì¡°ì‚¬ ì´ë¦„ êµ¬í•˜ê¸°

        SELECT *
        FROM Beers
        WHERE name IN (SELECT beer
        FROM Likes
        WHERE drinker = â€˜Fredâ€™);


### EXIST
EXISTS(\<relation\>): ë¹ˆ ê³µê°„ì´ ì•„ë‹ˆë¼ë©´

*From Beers(name, manf)*, ì œì¡°ì‚¬ë³„ ê³ ìœ  ë§¥ì£¼ êµ¬í•˜ê¸°

        SELECT name
        FROM Beers b1
        WHERE NOT EXISTS (
            SELECT *
            FROM Beers
            WHERE manf = b1.manf AND
                name <> b1.name);

### ANY
ANY(\<relation\>): í•˜ë‚˜ë¼ë„ í¬í•¨ (T/F)

### ALL
ALL(\<relation\>): ëª¨ë“  ì„œë¸Œì¿¼ë¦¬ tuple ì¡°íšŒ ë° ë¹„êµ

*x <> ALL(\<relation>\)*ëŠ” ëª¨ë“  ì„œë¸Œì¿¼ë¦¬ tuple ì¤‘ì—ì„œ xì™€ ê°™ì§€ ì•Šì€ íŠœí”Œ ë¦¬í„´

*Sells(bar, beer, price)*, ìµœê³ ê°€ë¡œ íŒ”ë¦° ë§¥ì£¼ êµ¬í•˜ê¸°

        SELECT beer
        FROM Sells
        WHERE price >= ALL(
            SELECT price
            FROM Sells);

## SQL ì‹¤ìŠµ âœ
        Product ( pname,  price, category, maker)
        Purchase (buyer,  seller,  store,  product)
        Company (cname, stock price, country)
        Person( per-name, phone number, city)

**Ex #1**: Find people who bought telephony products.

**Ex #2**: Find names of people who bought American products

**Ex #3**: Find names of people who bought American products and did not buy French products

**Ex #4**: Find names of people who bought American products and they live in Champaign.

**Ex #5**: Find people who bought stuff from Joe or bought products from a company whose stock prices is more than $50.

****
# Defining a Database Schema âœ’
## ë°°ê²½ì§€ì‹
- **INT or INTEGER** (synonyms).
- **REAL or FLOAT** (synonyms).
- **CHAR(n)** = fixed-length string of n  characters.
- **VARCHAR(n)** = variable-length string of up to n  characters.

## CREATE/DROP
		CREATE TABLE Sells (
			bar	CHAR(20),
			beer	VARCHAR(20),
			price	REAL
		);

		DROP TABLE <name>;

## DELETE
        ALTER TABLE Bars DROP license;

## Declaring Keys
### PRIMARY KEY or UNIQUE
        CREATE TABLE Beers (
			name	CHAR(20) UNIQUE,
			manf	CHAR(20)
		);

        CREATE TABLE Sells (
			bar	CHAR(20),
			beer	VARCHAR(20),
			price	REAL,
			PRIMARY KEY (bar, beer)
		);

- ì˜¤ë¡œì§€ í•˜ë‚˜ì˜ PRIMARY KEY, ì—¬ëŸ¬ ê°œì˜ UNIQUE
- PRIMARY KEY ì†ì„±ê°’ NULL ë¶ˆê°€, UNIQUE ê°€ëŠ¥
- DBMS ì¢…ë¥˜ì— ë”°ë¼, ìƒˆë¡œìš´ index ìƒì„±ì‹œ ìë™ KEY ìƒì„± ì°¨ì´ ì¡´ì¬
    - PRIMARY KEY ìƒì„± O, UNIQUE ìƒì„± X.
- UNIQUE
    - ìœ ì¼ì„± O
    - ì¤‘ë³µ ì œì–´
    - ê° ì»¬ëŸ¼ë§ˆë‹¤ ì§€ì • ê°€ëŠ¥

### DEFAULT
ê¸°ë³¸ê°’ ì§€ì •

        CREATE TABLE Drinkers (
            name CHAR(30) PRIMARY KEY,
            addr CHAR(50) DEFAULT â€˜123 Sesame St.â€™,
            phone CHAR(16)
	    );

ê¸°ë³¸ê°’ ì§€ì •ì„ í†µí•´, í•˜ê¸° ë¶ˆì™„ì „í•œ ì¿¼ë¦¬ë¬¸ì„ ì‹¤í–‰í•´ë„ ì²˜ë¦¬ë˜ëŠ” ëª¨ìŠµì´ë‹¤.

        INSERT INTO Drinkers(name)
		VALUES(â€˜Sallyâ€™);

![image](https://user-images.githubusercontent.com/39285147/195461490-3a6173b9-346b-4138-a20c-e47663fb9cc2.png)

> ë§Œì•½, 'phone' ì†ì„±ì— NOT NULLì´ë¼ë©´, ìƒê¸° INSERT ì¿¼ë¦¬ë¬¸ì€ ê±°ì ˆëœë‹¤.

### NOT NULL
NULL ê°’ í—ˆìš© X

****
# Database Modification ğŸ„
## INSERT
        INSERT INTO <relation>
		({ VALUE | <subquery> });

[*Likes í…Œì´ë¸”ì— VALUE ì¶”ê°€*]

        // Likes(drinker, beer)

        INSERT INTO Likes
		VALUES(â€˜Sallyâ€™, â€˜Budâ€™);

        INSERT INTO Likes(beer, drinker)
        VALUES(â€˜Budâ€™, â€˜Sallyâ€™);

[*Sallyê°€ ìì£¼ê°€ëŠ” barë¥¼ ë°©ë¬¸í•˜ëŠ” ë‹¤ë¥¸ ìŒì£¼ê°€ ëª©ë¡ ì¶”ê°€*]

        // Frequents(drinker, bar)

        INSERT INTO PotBuddies
        (SELECT d2.drinker
        FROM Frequents d1, Frequents d2
        WHERE d1.drinker = â€˜Sallyâ€™ AND
            d2.drinker <> â€˜Sallyâ€™ AND
            d1.bar = d2.bar
        );

## Delete
        DELETE FROM <relation>
		WHERE <condition>;

[*Likes í…Œì´ë¸”ì—ì„œ Sallyê°€ Bud ë§¥ì£¼ë¥¼ ë§ˆì‹  íŠœí”Œ ì‚­ì œ*]

        DELETE FROM Likes
		WHERE drinker = â€˜Sallyâ€™ AND beer = â€˜Budâ€™;

[*ëª¨ë“  íŠœí”Œ ì‚­ì œ*]

        DELETE FROM Likes;

[*ë™ì¼í•œ ì œì¡°ì—…ì²´ì˜ ë‹¤ë¥¸ ë§¥ì£¼ê°€ ìˆëŠ” ëª¨ë“  ë§¥ì£¼ ì‚­ì œ*]

        DELETE FROM Beers b
        WHERE EXISTS (
        SELECT name FROM Beers
        WHERE manf = b.manf AND
            name <> b.name);


## Update
        UPDATE <relation>
		SET <list of attribute assignments>
		WHERE <condition on tuples>;

[*Fred's phone numberì„ 555-1212ë¡œ ë³€ê²½*]

        UPDATE Drinkers
		SET phone = â€˜555-1212â€™
		WHERE name = â€˜Fredâ€™;

****
# Constraints ğŸ†
**Constraint**: ë°ì´í„° ê°„ ê´€ê³„ ê·œì¹™ (i.e., key constraints)

**Trigger**: íŠ¹ì • ì¡°ê±´ ì¶©ì¡±ì‹œ ë°œìƒ
- Constraints ë³´ë‹¤ êµ¬í˜„ ê°„í¸

**Value-based constraints**: íŠ¹ì • ì†ì„±ê°’ ê·œì œ

**Tuple-based constraints**: ìš”ì†Œë“¤ ê°„ ê´€ê³„ ê·œì¹™

## Foreign Keys(ì™¸ë˜í‚¤)
        FOREIGN KEY ( <list of attributes> )
		or
        REFERENCES <relation> ( <attributes> )

ê°€ë ¹, Sells(bar, beer, price)ì—ì„œ beer ì†ì„±ê³¼ Beersì˜ beer ì†ì„±ì„ ì—°ê²°ì§“ëŠ” ì™¸ë˜í‚¤ ì¶”ê°€

        CREATE TABLE Beers (
            name	CHAR(20) PRIMARY KEY,
            manf	CHAR(20) );

        CREATE TABLE Sells (
            bar	CHAR(20),
            beer	CHAR(20) REFERENCES Beers(name),
            price	REAL );

        CREATE TABLE Sells (
            bar	CHAR(20),
            beer	CHAR(20),
            price	REAL,
            FOREIGN KEY(beer) REFERENCES 	Beers(name));

**Foreign-key constraint**: ê´€ê³„ R | Primary key of relation: S
- INSERT/UPDATE to R: values not found in S.
- DELETE/UPDATE to S: some tuples of R to â€œdangleâ€
    - 1. Default : ë³€ê²½ ì·¨ì†Œ
    - 2. Cascade : R ìˆ˜ì •
        - Deleted \<attribute\>: R tuple ì‚­ì œ
        - Updated \<attribute\>: R ì†ì„± ì‚­ì œ.
    - 3. Set NULL : R & S í•´ë‹¹ ì†ì„± NULL ë³€ê²½.

í•˜ê¸° ì¡°ê±´ ì¶”ê°€ë¡œ DELETE/UPDATE ì •ì±…(Policy) ì„ íƒ ê°€ëŠ¥í•˜ë‹¤; ê¸°ë³¸ = Default

        ON [UPDATE, DELETE][SET NULL CASCADE]

        CREATE TABLE Sells (
            bar	CHAR(20),
            beer	CHAR(20),
            price	REAL,
            FOREIGN KEY(beer)
                REFERENCES Beers(name)
                ON DELETE SET NULL
                ON UPDATE CASCADE );

## CHECK   
        CHECK( <condition> ) 

The condition may use the name of the attribute, but any other relation or attribute name must be in a subquery.

Example 1:
- CHECK (price <= 5.00) ê°€ê²©ì´ $5 ë„˜ì–´ê°€ë©´ reject
- CHECK (beer IN (SELECT name FROM Beers)): Beersì— í•´ë‹¹ ë§¥ì£¼ ì—†ìœ¼ë©´ reject

        CREATE TABLE Sells (
            bar	CHAR(20),
            beer	CHAR(20)	CHECK ( beer IN
                    (SELECT name FROM Beers)),
            price	REAL CHECK ( price <= 5.00 )
        );

Example 2: ì˜¤ë¡œì§€ Joeâ€™s Barë§Œ $5 ë„˜ëŠ” ê°€ê²©ì— ë§¥ì£¼ íŒë§¤ ê°€ëŠ¥:
	
        CREATE TABLE Sells (
            bar		CHAR(20),
            beer		CHAR(20),
            price	REAL,
            CHECK (bar = â€™Joeâ€™â€™s Barâ€™ OR
                        price <= 5.00)
        );

## Assertions
Any SQL boolean expression

        CREATE ASSERTION <name>
			CHECK ( <condition> );

Example: *Sells(bar, beer, price)*, ì–´ë–¤ barë„ í‰ê·  $5 ì´ìƒ ë¶€ê³¼ ë¶ˆê°€ (T/F)

        CREATE ASSERTION NoRipoffBars CHECK (
            NOT EXISTS (
                SELECT bar FROM Sells
                GROUP BY bar
                HAVING 5.00 < AVG(price)
            ));

> ìˆ˜ì • ì‹œ, ì¼ì¼íˆ ëª¨ë“  ASSERTION í™•ì¸ ìš”ë§

****
# Reference 
[Database Management Systems by Raghu Ramakrishnan and Johannes Gehrke](https://pages.cs.wisc.edu/~dbbook/)
