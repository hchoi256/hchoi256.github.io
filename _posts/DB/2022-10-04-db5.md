---
layout: single
title: "DBMS: SQL"
categories: DB
tag: [Database, SQL]
toc: true
toc_sticky: true
toc_label: "쭌스log"
#author_profile: false
header:
    teaser: /assets/images/posts/db.png
sidebar:
    nav: "docs"
---

# INTRO 🙌
저번 시간에는 ER Diagram을 Relation Model/Design으로 변환에 대하여 알아보았다.

이번 시간에는 실질적으로 **SQL(Structured Query Language)**을 사용하여 모델을 생성해보자.

        SELECT    S
        FROM       R1,…,Rn
        WHERE    C1
        GROUP BY a1,…,ak
        HAVING     C2

****
# SQL 배경지식 ✌
- 대소문자 구분 X
- 문장 맨 뒤 ;
- 문자열은 작은 따옴표(')로 표시
- '==' 대신 '='
- NULL은 집계 함수에 영향 x; non-NULL 없는 집합에서 집계 함수는 NULL 리턴 

## SQL 쿼리 구조
        SELECT [ALL | DISTINCT] 속성이름들
        FROM 테이블이름들
        WHERE 조건들
        GROUP BY 속성이름
        HAVING 검색조건들
        ORDER BY 속성이름 [ASC | DESC]

## SQL 문법 처리순서
        1. FROM
        2. ON
        3. JOIN
        4. WHERE
        5. GROUP BY
        6. HAVING
        7. SELECT
        8. DISTINCT
        9. ORDER BY
        10. TOP

## 집계 함수
        SUM([ALL | DISTINCT] 속성이름)
        AVG([ALL | DISTINCT] 속성이름)
        COUNT({[[ALL | DISTINCT] 속성이름] | *})
        MAX([ALL | DISTINCT] 속성이름)
        MIN([ALL | DISTINCT] 속성이름)

> DISTINCT: 중복 제거

****
# SQL 문법💜
## Single-Relation Query
하나의 관계(테이블)를 포함하는 쿼리문 작성

### Select, From, Where
        SELECT   속성들
        FROM     테이블들
        WHERE    조건들

*Beers* 테이블에서 *Anheuser-Busch* 회사에서 만든 맥주 데이터 불러오기

		SELECT *
		FROM Beers
		WHERE manf = ‘Anheuser-Busch’;

> Output:
> ![image](https://user-images.githubusercontent.com/39285147/195394010-4829098e-fb4b-49a7-b964-9d00dca984ce.png)

### AND, OR, NOT, AS, LIKE
**AND Operator**

        SELECT *
        FROM Company
        WHERE country="USA" AND stockPrice > 50

**AS Operator**

        SELECT bar, beer, price * 120 AS priceInYen
        FROM Sells;

> Output:
> ![image](https://user-images.githubusercontent.com/39285147/195394910-da6218e3-0801-489b-99b4-509ce0d41698.png)

        SELECT drinker, ‘likes Bud’ AS whoLikesBud
        FROM Likes
        WHERE beer = ‘Bud’;

> Output:
> ![image](https://user-images.githubusercontent.com/39285147/195395096-a7533bad-3955-4448-bc8e-faccc1b3f407.png)

**Like Operator**

        <Attribute> LIKE <pattern>
        <Attribute> NOT LIKE <pattern>

%  = any sequence of characters
_   = any single character

        SELECT name
        FROM Drinkers
        WHERE phone LIKE ‘%555-_ _ _ _’;

        SELECT *
        FROM Company
        WHERE country=“USA” AND address LIKE “%Mountain%”

## Multi-Table Queries
다수의 관계(테이블)들을 포함하는 쿼리문 작성

        SELECT Person.name
        FROM Person, Purchase, Product
        WHERE Person.name=Purchase.buyer AND Product=Product.name AND Product.category=“telephony”

### Explicit Tuple-Variables
        SELECT b1.name, b2.name
            FROM Beers b1, Beers b2
            WHERE b1.manf = b2.manf AND
                b1.name < b2.name;

        SELECT b1.name, b2.name
            FROM Beers AS b1, Beers AS b2
            WHERE b1.manf = b2.manf AND
                b1.name < b2.name;

상기 쿼리문에서 **Beers b1, Beers b2** 부분에 해당한다.

여기서, Tuple Variable은 각각 b1, b2이다.

        SELECT a1, a2, …, ak
        FROM    R1 AS x1, R2 AS x2, …, Rn AS xn
        WHERE  Conditions

[*Nested Loops*]

![image](https://user-images.githubusercontent.com/39285147/195452009-d427e1f2-d459-4421-88ce-b0453b243e4b.png)

[*Parallel Assignment*]

![image](https://user-images.githubusercontent.com/39285147/195452140-88370af2-fb40-43d5-8564-ffe71c2638ed.png)

[*Translation to Relational algebra*]

![image](https://user-images.githubusercontent.com/39285147/195452380-f46dbc60-9ef5-4195-a4e1-4a32890e768a.png)

## Group-by, Having
**Group-by**

Sells(bar, beer, price) 테이블에서 **맥주별** 평균 가격 구하기:

        SELECT beer, AVG(price)
        FROM Sells
        GROUP BY beer;

※ 만약 쿼리가 집계 함수 포함 → SELECT로 내보낼 다른 요소 또한 집계됐거나, 해당 속성이 GROUP BY 목록에 포함되어야 한다.

아래 예시를 통해 이해해보자.

        SELECT bar, MIN(price)
        FROM Sells
        WHERE beer = ‘Bud’;

price 속성은 집계 함수가 사용된 반면, bar 속성은 집계되지 않았으므로 오류이다.

**Having**
GROUP BY 사용으로 생성된 각 그룹별로 HAVING 조건에 해당되지 않는 Tuple 제거.

[*예시*]

*Sells(bar, beer, price) & Beers(name, manf)*: Pete's에 의해 제작되었거나 3개 이상의 bars에서 판매되고 있는 맥주들의 평균 가격 구하기

        SELECT beer, AVG(price)
        FROM Sells
        GROUP BY beer
        HAVING COUNT(bar) >= 3 OR beer IN (SELECT name FROM Beers WHERE manf = ‘Pete’’s’);

****
# SQL 실습 ✏
        Product ( pname,  price, category, maker)
        Purchase (buyer,  seller,  store,  product)
        Company (cname, stock price, country)
        Person( per-name, phone number, city)

**Ex #1**: Find people who bought telephony products.

**Ex #2**: Find names of people who bought American products

**Ex #3**: Find names of people who bought American products and did not buy French products

**Ex #4**: Find names of people who bought American products and they live in Champaign.

**Ex #5**: Find people who bought stuff from Joe or bought products from a company whose stock prices is more than $50.

****
# Reference 
[Database Management Systems by Raghu Ramakrishnan and Johannes Gehrke](https://pages.cs.wisc.edu/~dbbook/)
