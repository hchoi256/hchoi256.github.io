---
layout: single
title: "DBMS: ë°ì´í„° ì €ì¥ Disks and Files"
categories: DB
tag: [Database, Disk, Files, Buffer]
toc: true
toc_sticky: true
toc_label: "ì­ŒìŠ¤log"
#author_profile: false
header:
    teaser: /assets/images/posts/db.png
sidebar:
    nav: "docs"
---

# INTRO ğŸ™Œ
ì €ë²ˆ ì‹œê°„ì—ëŠ” SQLì— ëŒ€í•˜ì—¬ ì•Œì•„ë³´ì•˜ë‹¤.

        Select eid, ename
        From Employees
        Where salary > 100K

ìƒê¸° SQL ë¬¸ì„ ì…ë ¥í•˜ë©´, ì‹œìŠ¤í…œì€ *Employees* í…Œì´ë¸”ì„ ìŠ¤ìº”(scan)í•œë‹¤.
- considers each tuple
- if salary > 100K, then return eid, ename

ì´ë²ˆ ì‹œê°„ì—ëŠ” ìƒê¸° ê³¼ì •ì´ **ë°±ì•¤ë“œ(back-end)ì—ì„œ ì–´ë–»ê²Œ ì¼ì–´ë‚˜ëŠ” ê²ƒ**ì¸ì§€, ê·¸ë¦¬ê³   **Disk, Files, Buffer Manager** ì„¸ ê°€ì§€ ê°œë…ì— ëŒ€í•´ ì•Œì•„ë³´ì.

## Background Knowledge
- í…Œì´ë¸”ì€ file í˜•íƒœë¡œ diskì— ì €ì¥ëœë‹¤
- íŒŒì¼ì€ ë‹¤ìˆ˜ì˜ pagesë¥¼ ê°–ëŠ”ë‹¤.
- ê° í˜ì´ì§€ëŠ” ë‹¤ìˆ˜ tuples(rows)ë¥¼ ê°–ëŠ”ë‹¤.
- ì‹œìŠ¤í…œ(RDBMS)ì€ ë©”ëª¨ë¦¬(buffer)ì—ì„œ í•œ ë²ˆì— í•œ í˜ì´ì§€ë¥¼ ì²˜ë¦¬í•œë‹¤.

****
# Layer Architecture (DBMS) ğŸ“Œ
![image](https://user-images.githubusercontent.com/39285147/194167732-ebb289d7-bd84-4432-bfd4-c82121227d4f.png)

> ìƒê¸° ëª¨í˜•ì€:
>> *concurrency control(ë™ì‹œì„±)*ê³¼ *recovery components(ë³µêµ¬)*ë¥¼ í¬í•¨í•˜ì§€ ì•ŠëŠ”ë‹¤.
>> ê°€ëŠ¥í•œ ì•„í‚¤í…ì³ ì¤‘ í•˜ë‚˜ì˜ í˜•íƒœì´ë‹¤; ê° ì‹œìŠ¤í…œì€ ì•½ê°„ ë‹¤ë¥¸ í˜•íƒœë¥¼ ê°€ì§€ê³  ìˆë‹¤.

ì•„ë˜ SQL ë¬¸ì„ ì…ë ¥í•˜ë©´ back-end(*ìƒê¸° ëª¨í˜•ì˜ ê° ë‹¨ê³„*)ì—ì„œ ì–´ë–¤ ì²˜ë¦¬ê°€ ì¼ì–´ë‚˜ëŠ”ì§€ ì•Œì•„ë³´ì.
        
        Select eid, ename
        From Employees
        Where salary > 100K

![image](https://user-images.githubusercontent.com/39285147/194169277-44ed02ae-2023-4d57-9b95-6888f0eb5bf7.png)

## 1. Query Optimization and Execution
1. **ë°ì´í„° ì°¾ê¸°**: scan through entire table to look at certain appropriate data
2. **ë°ì´í„° ë½‘ê¸°**: indexing

## 2. Relational Operators
![image](https://user-images.githubusercontent.com/39285147/194177481-837a5ddd-7c10-4449-b064-6247d63a7924.png)

## 3. Files and Access Methods
Disk block ì ‘ê·¼ ì‹œê°„(read/write):
- **seek time**: track ì´ë™ ì‹œê°„(moving arms to position disk head on track)
    - varies from about 1 to 20msec
- **rotational delay**: í•œ trackì—ì„œ desired positionê¹Œì§€ íšŒì „ ì‹œê°„(waiting for block to rotate under head)
    - varies from 0 to 10msec
- **transfer time**: do reads/writes(actually moving data to/from disk surface)
    - about 1msec per 4KB page

> Key to lower I/O cost: **reduce seek/rotation delays!**

> Reading pages from disk, writing to pages on disk = very expensive
>> try to minimize this if we can

## 4. Buffer Management
![image](https://user-images.githubusercontent.com/39285147/194176431-22a6332b-4329-486d-8923-c807820c3707.png)

- ë°ì´í„°ëŠ” **RAM** ì•ˆì— ìœ„ì¹˜í•´ì•¼ ì‹¤í–‰ ê°€ëŠ¥
- Tableì—ì„œ ë°ì´í„° ì €ì¥ í˜•íƒœ: *<frame#, pageid>* pairs

ë§Œì•½ í•˜ë‚˜ì˜ í˜ì´ì§€ ìš”ì²­ì´ ë“¤ì–´ì™”ë‹¤ê³  ê°€ì •í•´ë³´ì:
1. ë§Œì•½ ìš”ì²­ëœ í˜ì´ì§€ê°€ pool ì•ˆì— ì¡´ì¬í•˜ì§€ ì•Šì„ ê²½ìš°:
    - **Replacement** ìœ„í•œ frame ì„ íƒ
        - *pin count = 0* ë§Œì¡±í•˜ëŠ” pageê°€ replacement í›„ë³´
    - If frame is **dirty*, write it to disk
    - ìš”ì²­í•œ í˜ì´ì§€ë¥¼ ì„ íƒí•œ frameìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
2. í˜ì´ì§€ ê³ ì •(*Pin*) ë° í•´ë‹¹ address ì´ë™
3. ì™„ë£Œ ì´í›„, í˜ì´ì§€ ìš”ì²­ìëŠ” í•´ë‹¹ í˜ì´ì§€ release í•´ì•¼í•¨
    - *unpin* it
    - **dirty** ìƒíƒœë¡œ ë§Œë“¤ì–´ì„œ í˜ì´ì§€ ìˆ˜ì • ì—¬ë¶€ ê¸°ë¡
4. ìƒˆë¡œìš´ í˜ì´ì§€ ìš”ì²­ ë“¤ì–´ì˜¬ ê²½ìš°, ìƒê¸° ê³¼ì • ë°˜ë³µ

> **dirty set**
>> í•´ë‹¹ í˜ì´ì§€ê°€ memory ì¡´ì¬í•˜ì§€ë§Œ diskì— ì €ì¥ëœ ì •ë³´ì™€ ë‹¤ë¥¸ ê²½ìš°

> **LRU**
>> ![image](https://user-images.githubusercontent.com/39285147/197597232-bd285176-f3b7-4565-9bea-511b64b0824c.png)

### Buffer Replacement Policy
- Frameì€ **replacement policy**ì— ì˜ê±°í•œë‹¤ (i.e., Least-recently-used (LRU), Clock, MRU etc.)
- PolicyëŠ” ê° **access pattern**ì— ë”°ë¼ I/O ê°œìˆ˜ì— ì˜í–¥ì„ ë¯¸ì¹œë‹¤.
- ***Sequential flooding***: *LRU* + *repeated sequential scans*ì— ì˜í•´ ë°œìƒí•˜ëŠ” ë¬¸ì œì´ë‹¤.
    - **Number of buffer frames < # pages in file** means each page request causes an I/O.
        - LRU ë°©ì‹ìœ¼ë¡œëŠ” ê° ìš”ì²­ë§ˆë‹¤ page miss ë°œìƒ (cost â†‘)
    - *MRU*ë¥¼ í†µí•´ *ë¶€ë¶„ì ìœ¼ë¡œ* ê°œì„  ê°€ëŠ¥

> **Sequential flooding**
>> ![image](https://user-images.githubusercontent.com/39285147/197595101-b6051910-daa1-4686-ad43-10ef00c25af1.png)

## 5. Disk Space Management
- **Lowest layer** of DBMS software manages space on disk.
- **Higher levels** call upon this layer to:
    - *allocate/delete* a page
    - *read/write* a page

# Disks ğŸ—‚
- ë¶€ìˆ˜ì  ì €ì¥ ê³µê°„ (Secondary storage device of choice)
- **random access** vs. **sequential access**
- ë°ì´í„° ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°ëŠ” ë‹¤ìŒ unitsì„ í†µí•´ ì¼ì–´ë‚œë‹¤: **disk blocks** or **pages**.

## Disk êµ¬ì„±
> [Disk Simulation]( https://animagraffs.com/hard-disk-drive/)

[*Disk êµ¬ì¡°1*]

![image](https://user-images.githubusercontent.com/39285147/194168785-1d8fcab0-73d4-49c7-b911-d61d4af9db0d.png)

[*Disk êµ¬ì¡°2*]

![image](https://user-images.githubusercontent.com/39285147/194170939-de56d0d1-7a10-4334-83f8-61f52d705869.png)

1. The platters spin (say, *90rps*).
2. Arm assemblyëŠ” head ìœ„ì¹˜ë¥¼ ì•Œë§ì€ track(desired track)ìœ¼ë¡œ ì›€ì§ì¸ë‹¤

![ezgif com-gif-maker](https://user-images.githubusercontent.com/39285147/194169839-e3072926-3f9e-4fb4-bc7f-0cf613a783d3.gif)

-  Tracks under heads  make a **cylinder** (imaginary!).

3. í•˜ë‚˜ì˜ headê°€ **í•œ ë²ˆì— í•˜ë‚˜ì”© reads/writes** ëª…ë ¹ ê°€ëŠ¥
4. **Block size**ëŠ” ë‹¤ìˆ˜ì˜ **sector size** ì§‘í•©ì²´ì´ë‹¤.

# Files of Records ğŸ—‚
- Page, blockë§Œìœ¼ë¡œë„ I/O ì²˜ë¦¬ ê°€ëŠ¥í•˜ì§€ë§Œ, ê³ ìˆ˜ì¤€ DBMSëŠ” **records**ì™€ **files of records**ë¥¼ í•„ìš”ë¡œ í•œë‹¤.
- ***FILE***: pageë“¤ì˜ ëª¨ìŒ; ê° í˜ì´ì§€ëŠ” recordë“¤ì˜ ëª¨ìŒ.
    - insert/delete/modify record
    - íŠ¹ì • record ì¼ê¸° (record id ì´ìš©)
    - ëª¨ë“  records ìŠ¤ìº” (possibly with some conditions on the records to be retrieved)

> Sorted File

## Heap File (Unordered Files)
- ê°€ì¥ ê°„ë‹¨í•œ fileì€ ë¬´ì‘ìœ„ ìˆœì„œë¡œ recordsë¥¼ ë³´ê´€í•œë‹¤.
- Fileê°€ grow/shrink í• ìˆ˜ë¡, disk pagesëŠ” allocated/de-allocated ëœë‹¤.
- record ìˆ˜ì¤€ ì²˜ë¦¬ í•„ìš”ì¡°ê±´:
    - Fileì—ì„œ pages ì¶”ì²™í•˜ê¸°
    - Pagesì—ì„œ free space ì¶”ì í•˜ê¸°
    - Pagesì—ì„œ records ì¶”ì í•˜ê¸°

ì´ ì™¸ì—ë„ ë§ì€ ì¶”ì  ë°©ë²•ì— ëŒ€í•œ ëŒ€ì•ˆì±…ì´ ì¡´ì¬í•œë‹¤.

### 1. *List* ë°©ì‹
![image](https://user-images.githubusercontent.com/39285147/194657109-000eb4db-4fe6-4dc1-86fa-607367955cc9.png)

- header page idì™€ Heap file nameì€ ë‹¤ë¥¸ ì¥ì†Œì— ì €ì¥ë˜ì–´ ìˆë‹¤.
- ê° í˜ì´ì§€ëŠ” ë‘ ê°œì˜ *pointers*ì™€ dataë¥¼ ê°–ëŠ”ë‹¤; double linked-list

### 2. *Page Directory* ë°©ì‹
![image](https://user-images.githubusercontent.com/39285147/194666401-07f6800e-9a45-4c46-8779-1de1a21ed03b.png)

- í•œ pageì˜ entryëŠ” í•´ë‹¹ pageì—ì„œ free bytesì˜ ê°œìˆ˜ë¥¼ í¬í•¨í•  ìˆ˜ ìˆë‹¤.
- DirectoryëŠ” pageë“¤ì˜ ëª¨ìŒì´ë‹¤; linked list êµ¬í˜„ì€ ê·¸ì € í•œ ê°€ì§€ ëŒ€ì•ˆì±…ì´ë‹¤.
    - ~~Page Directory ë°©ì‹ì´ ëª¨ë“  HeapFile pagesì— ëŒ€í•œ linked list êµ¬í˜„ë³´ë‹¤ ë” ê°€ë³ë‹¤/ê°„ì†Œí•˜ë‹¤.~~

## Page Formats
### 1. *Fixed* Length Records
![image](https://user-images.githubusercontent.com/39285147/194668066-94c5dc9c-0b6a-446d-ba68-7a52b167c77e.png)

- **Record id = <page id, slot #>**
- í˜ì´ì§€ì—ì„œ Recordsë¥¼ free spaceë¡œ ì´ë™í•˜ëŠ” ê²ƒì€ ridë¥¼ ë°”ê¾¼ë‹¤; ë”°ë¼ì„œ, ê²½ìš°ì— ë”°ë¼ì„œ record movementê°€ ë¶ˆê°€ëŠ¥í•˜ë‹¤.

![image](https://user-images.githubusercontent.com/39285147/194669732-9d1d9539-eb58-42f6-b5da-93656c9e8da8.png)

- Fileì˜ ëª¨ë“  recordsì— ì ìš©ëœ field type ì •ë³´ëŠ” **system catalogs**ì— ì €ì¥ë˜ì–´ ìˆë‹¤.
- ië²ˆì§¸ field íƒìƒ‰ì€ record ìŠ¤ìº”ì„ í•„ìš”ë¡œí•˜ì§€ ì•ŠëŠ”ë‹¤; length ê³ ì •ê°’ì´ë¼ ë°”ë¡œ ìœ„ì¹˜ ê³„ì‚° ê°€ëŠ¥

### 2. *Variable* Length Records
![image](https://user-images.githubusercontent.com/39285147/194668235-bdb423c8-49b1-4642-b78a-b8eca7e3d555.png)

í˜ì´ì§€ì—ì„œ Recordsë¥¼ rid ë³€ê²½ ì—†ì´ ì´ë™ ê°€ëŠ¥í•˜ë‹¤; fixed-length recordsì—ë„ ì ìš© ê°€ëŠ¥.

![image](https://user-images.githubusercontent.com/39285147/194679053-3a1731e0-ffd9-47e1-81a0-306048677b0e.png)

ë‘ ë²ˆì§¸ ì˜µì…˜(Array of Field Offsets)ì€ íš¨ìœ¨ì  **null** ì €ì¥ ë°©ì‹ì„ ê°–ê³  ìˆë‹¤.
- ië²ˆì§¸ fieldì— ì§ì ‘ ì ‘ê·¼; small directory overhead

### Fixed vs. Variable Length
Variable-length representation
- Space-efficient
- Costly record rearrangement is possible

Fixed-length representation
- Easy implementation of random access
- Wastes space

## System Catalogs
![image](https://user-images.githubusercontent.com/39285147/194679395-a8abe8aa-d02c-4d8f-94ea-6b4f72d82c77.png)

ê° indexëŠ” structure (e.g., B+ tree)ì™€ search key fieldsë¥¼ ê°€ì§„ë‹¤

ê° relationì€ ë‹¤ìŒì„ ê°€ì§„ë‹¤:
- **name, file name, file structure (e.g., heap file)**
- attribute name and type, for each attribute
- index name
- integrity constraints

ê° viewëŠ” view nameê³¼ definitionë¥¼ ê°€ì§„ë‹¤.

Statistics, authorization, buffer pool size, etc.
- **Catalogsë“¤ì€ relationsìœ¼ë¡œ ì €ì¥ëœë‹¤.**
    
ë‹¤ìŒ ì‹œê°„ì—ëŠ” [File Organiaztion & Indexing](https://hchoi256.github.io/db/db7/)ì— ëŒ€í•´ ì•Œì•„ë³´ì.

****
# Reference 
[Database Management Systems by Raghu Ramakrishnan and Johannes Gehrke](https://pages.cs.wisc.edu/~dbbook/)

[Relational Operators](https://www.javatpoint.com/dbms-relational-algebra)